name: Conformance Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: conformance-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  server-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          enable-cache: true
          version: 0.9.5
      - run: uv sync --frozen --all-extras --package mcp-everything-server
      - name: Start everything-server
        run: |
          uv run --frozen mcp-everything-server --port 3001 &
          timeout 15 bash -c 'until curl -s http://localhost:3001/mcp > /dev/null 2>&1; do sleep 0.5; done'
          echo "Server ready"
      - uses: modelcontextprotocol/conformance@4a42c25058c4636aca1ae7f6547ee30805de36ee
        with:
          mode: server
          url: http://localhost:3001/mcp
          expected-failures: ./conformance-baseline.yml

  client-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          enable-cache: true
          version: 0.9.5
      - run: uv sync --frozen --all-extras --package mcp
      - uses: modelcontextprotocol/conformance@4a42c25058c4636aca1ae7f6547ee30805de36ee
        with:
          mode: client
          command: "uv run --frozen python .github/actions/conformance/client.py"
          suite: all
          expected-failures: ./conformance-baseline.yml
